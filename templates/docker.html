<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker - NetControl Containers</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Tab Styling Matching the reference */
        .tabs {
            display: flex;
            gap: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            padding-bottom: 0;
        }

        .tab {
            background: none;
            border: none;
            padding: 10px 5px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Settings specific styles */
        .settings-panel {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .form-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .form-row:last-child {
            border-bottom: none;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-description {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
            margin: 5px 0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .stat-sub {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: auto;
        }

        /* Container Grid for Realtime View */
        .container-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .container-card-grid {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .container-card-grid:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-running {
            background-color: var(--success-color);
            box-shadow: 0 0 5px var(--success-color);
        }

        .status-exited {
            background-color: var(--text-muted);
        }

        .status-paused {
            background-color: var(--warning-color);
        }

        .resource-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }

        .resource-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        .resource-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
    </style>
</head>

<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>NetControl</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <!-- ... existing nav ... -->
                <a href="/" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="/docker" class="nav-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg>
                    <span>Docker</span>
                </a>
                <a href="/kubernetes" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    <span>Kubernetes</span>
                </a>
                <a href="/files" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                    <span>File Explorer</span>
                </a>
                <a href="/terminal" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>Terminal</span>
                </a>
                <a href="/wireguard" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.131A8 8 0 008 8mc0-4.144" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" />
                    </svg>
                    <span>WireGuard</span>
                </a>
                <a href="/settings" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="avatar">{{.Username}}</div>
                    <span>{{.Username}}</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Main Content (Rest of body) -->
        <main class="main-content">
            <header class="header">
                <h1>üê≥ Docker Management</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="loadContainers(); checkStatus(); loadOverview()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Refresh
                    </button>
                </div>
            </header>

            <div class="content">
                <!-- Tabs -->
                <div id="dockerContent">
                    <div class="tabs">
                        <button class="tab" onclick="switchTab('overview')">Overview</button>
                        <button class="tab active" onclick="switchTab('containers')">Container</button>
                        <button class="tab" onclick="switchTab('images')">Images</button>
                        <button class="tab" onclick="switchTab('settings')">Settings</button>
                    </div>

                    <!-- Overview Tab -->
                    <div id="overviewTab" class="tab-content" style="display: none;">
                        <div class="section-card">
                            <h2>Resource Overview</h2>
                            <div class="stats-grid" id="resourceOverview">
                                <!-- Populated by JS -->
                                <div class="stat-card">
                                    <div class="stat-label">Containers</div>
                                    <div class="stat-value">-</div>
                                    <div class="stat-sub">Space used: -</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Images</div>
                                    <div class="stat-value">-</div>
                                    <div class="stat-sub">Space used: -</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Volumes</div>
                                    <div class="stat-value">-</div>
                                    <div class="stat-sub">Space used: -</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Networks</div>
                                    <div class="stat-value">-</div>
                                    <div class="stat-sub">Created networks</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Containers Tab -->
                    <div id="containersTab" class="tab-content">
                        <div class="section-card">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h2>Containers</h2>
                                <div>
                                    <label
                                        style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); margin-right: 15px; display: inline-flex;">
                                        <input type="checkbox" id="showAllContainers" onchange="loadContainers()">
                                        Show all containers
                                    </label>
                                    <button class="btn btn-sm btn-primary" onclick="loadContainers()">Refresh
                                        List</button>
                                </div>
                            </div>
                            <div id="containerList" class="container-grid">
                                <!-- Populated by JS -->
                                <div class="empty-state">
                                    <span class="badge badge-warning">Checking Docker...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Images Tab -->
                    <div id="imagesTab" class="tab-content" style="display: none;">
                        <div class="section-card">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h2>Images</h2>
                                <button class="btn btn-primary btn-sm" onclick="showPullModal()">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Pull Image
                                </button>
                            </div>
                            <div id="imageList"></div>
                        </div>
                    </div>

                    <!-- Settings Tab (Installer) -->
                    <div id="settingsTab" class="tab-content" style="display: none;">
                        <div class="settings-panel">
                            <h2>Docker Settings</h2>

                            <!-- Status -->
                            <div class="form-row">
                                <div>
                                    <div class="form-label">Run Status</div>
                                    <div class="form-description">Current status of the Docker service</div>
                                </div>
                                <div id="dockerStatus" class="status-info">
                                    <span class="badge badge-warning">Checking...</span>
                                </div>
                            </div>

                            <!-- Version -->
                            <div class="form-row">
                                <div>
                                    <div class="form-label">Version</div>
                                    <div class="form-description">Installed Docker version</div>
                                </div>
                                <div id="dockerVersion" style="color: var(--text-secondary);">
                                    -
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="form-row">
                                <div>
                                    <div class="form-label">Actions</div>
                                    <div class="form-description">Manage Docker service</div>
                                </div>
                                <div id="dockerButtons" style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" id="installDockerBtn" onclick="installDocker()"
                                        style="display: none;">Install Docker</button>
                                    <button class="btn btn-warning" id="restartDockerBtn"
                                        onclick="restartSoftware('docker')" style="display: none;">Restart
                                        Service</button>
                                    <button class="btn btn-danger" id="uninstallDockerBtn" onclick="uninstallDocker()"
                                        style="display: none;">Uninstall</button>
                                </div>
                            </div>

                            <!-- Installation Progress Panel -->
                            <div id="installProgress"
                                style="display: none; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                                <h3>Operation Progress</h3>
                                <div class="install-progress">
                                    <div class="install-progress-bar">
                                        <div class="install-progress-fill" id="progressBar" style="width: 0%;"></div>
                                    </div>
                                    <div class="install-status" id="progressStatus">Starting...</div>
                                </div>
                                <div class="log-viewer" id="installLogs" style="margin-top: 1rem; height: 200px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Logs Modal -->
    <div class="modal-overlay" id="logsModal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Container Logs</h3>
                <button class="modal-close" onclick="hideModal('logsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="log-viewer" id="logsContent"></div>
            </div>
        </div>
    </div>

    <!-- Create Container Modal -->
    <div class="modal-overlay" id="createContainerModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Create Container</h3>
                <button class="modal-close" onclick="hideModal('createContainerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="createImageName">Image</label>
                    <input type="text" class="form-control" id="createImageName" readonly disabled>
                </div>
                <div class="form-group">
                    <label for="createContainerName">Container Name</label>
                    <input type="text" class="form-control" id="createContainerName" placeholder="e.g., my-app">
                </div>
                <div class="form-group">
                    <label for="createContainerPorts">Exposed Ports (Host:Container)</label>
                    <input type="text" class="form-control" id="createContainerPorts" placeholder="e.g., 8080:80">
                    <small>Separate multiple ports with commas</small>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex:1; margin-right: 10px;">
                        <label for="createContainerMem">Memory (MB)</label>
                        <input type="number" class="form-control" id="createContainerMem" value="512">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="createContainerCPU">CPU (Cores)</label>
                        <input type="number" class="form-control" id="createContainerCPU" value="0.5" step="0.1">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('createContainerModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createContainer()">Create & Start</button>
            </div>
        </div>
    </div>

    <!-- Pull Image Modal -->
    <div class="modal-overlay" id="pullModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Pull Image</h3>
                <button class="modal-close" onclick="hideModal('pullModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="imageName">Image Name</label>
                    <input type="text" class="form-control" id="imageName" placeholder="e.g., nginx:latest">
                </div>
                <div id="pullProgress" style="display: none;">
                    <div class="log-viewer" id="pullLogs" style="height: 200px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('pullModal')">Cancel</button>
                <button class="btn btn-primary" id="pullBtn" onclick="pullImage()">Pull</button>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        let dockerAvailable = false;
        let statsWS = null;

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').style.display = 'block';

            if (tab === 'images') loadImages();
            if (tab === 'overview') loadOverview();

            // Handle realtime updates via WebSocket
            if (tab === 'containers') {
                loadContainers();
                connectStatsWS();
            } else {
                disconnectStatsWS();
            }
        }

        function disconnectStatsWS() {
            if (statsWS) {
                statsWS.close();
                statsWS = null;
            }
        }

        function connectStatsWS() {
            if (statsWS) return; // Already connected

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/docker/system/ws`;

            statsWS = new WebSocket(wsUrl);

            statsWS.onopen = () => {
                console.log('Docker stats connected');
            };

            statsWS.onmessage = (event) => {
                try {
                    const statsMap = JSON.parse(event.data);
                    updateUIWithStats(statsMap);
                } catch (e) {
                    // console.error("WS Parse Error", e);
                }
            };

            statsWS.onclose = () => {
                console.log('Docker stats disconnected');
                statsWS = null;
                // Auto-reconnect if still on containers tab
                if (document.getElementById('containersTab').style.display === 'block') {
                    setTimeout(connectStatsWS, 3000);
                }
            };

            statsWS.onerror = (e) => {
                // console.error('WS Error', e);
            };
        }

        function updateUIWithStats(statsMap) {
            for (const [id, stats] of Object.entries(statsMap)) {
                // Check if card exists
                const cpuEl = document.getElementById(`cpu-val-${id}`);
                const cpuBar = document.getElementById(`cpu-bar-${id}`);
                const memEl = document.getElementById(`mem-val-${id}`);
                const memBar = document.getElementById(`mem-bar-${id}`);

                if (cpuEl) {
                    cpuEl.textContent = `${stats.cpu_percent.toFixed(1)}%`;
                    cpuBar.style.width = Math.min(stats.cpu_percent, 100) + '%';

                    memEl.textContent = formatBytes(stats.memory_usage) + ' / ' + formatBytes(stats.memory_limit);
                    memBar.style.width = Math.min(stats.memory_percent, 100) + '%';
                }
            }
        }

        async function loadOverview() {
            try {
                const usage = await NetControl.api.get('/api/docker/system/usage');
                const grid = document.getElementById('resourceOverview');
                grid.innerHTML = `
                                <div class="stat-card">
                                    <div class="stat-label">Containers</div>
                                    <div class="stat-value">${usage.containers}</div>
                                    <div class="stat-sub">Space used: ${formatBytes(usage.containers_size)}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Images</div>
                                    <div class="stat-value">${usage.images}</div>
                                    <div class="stat-sub">Space used: ${formatBytes(usage.images_size)}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Volumes</div>
                                    <div class="stat-value">${usage.volumes}</div>
                                    <div class="stat-sub">Space used: ${formatBytes(usage.volumes_size)}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Networks</div>
                                    <div class="stat-value">${usage.networks}</div>
                                    <div class="stat-sub">Created networks</div>
                                </div>
                                `;
            } catch (e) {
                console.error("Failed to load overview", e);
            }
        }

        // ... existing checkStatus ...

        async function checkStatus() {
            // Check status via installer API for Settings tab integration
            try {
                const data = await NetControl.api.get('/api/installer/status');

                // Docker Settings Tab Update
                const dockerStatusEl = document.getElementById('dockerStatus');
                const dockerVersionEl = document.getElementById('dockerVersion');
                const installDockerBtn = document.getElementById('installDockerBtn');
                const uninstallDockerBtn = document.getElementById('uninstallDockerBtn');
                const restartDockerBtn = document.getElementById('restartDockerBtn');

                if (data.docker.installed) {
                    dockerStatusEl.innerHTML = `<span class="badge badge-success">Installed</span> ${data.docker.running ? '<span class="badge badge-success">Running</span>' : '<span class="badge badge-danger">Stopped</span>'}`;
                    dockerVersionEl.textContent = data.docker.version || 'Unknown';

                    installDockerBtn.style.display = 'none';
                    uninstallDockerBtn.style.display = 'inline-flex';
                    restartDockerBtn.style.display = 'inline-flex';

                    dockerAvailable = true;
                } else {
                    dockerStatusEl.innerHTML = '<span class="badge badge-danger">Not Installed</span>';
                    dockerVersionEl.textContent = '-';

                    installDockerBtn.style.display = 'inline-flex';
                    uninstallDockerBtn.style.display = 'none';
                    restartDockerBtn.style.display = 'none';

                    dockerAvailable = false;
                }

                // If on containers tab and available, refresh list
                if (dockerAvailable) {
                    // Check if list is empty or "checking", if so load
                    if (document.getElementById('containerList').querySelector('.badge-warning')) {
                        loadContainers();
                    }
                } else {
                    // Show message in container list
                    document.getElementById('containerList').innerHTML = `
                        <div class="empty-state">
                            <h3>Docker Not Available</h3>
                            <p>Please go to <a href="#" onclick="switchTab('settings');  document.querySelectorAll('.tab')[3].classList.add('active'); document.querySelectorAll('.tab')[1].classList.remove('active');">Settings</a> to install Docker.</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error("Failed to check status:", error);
                document.getElementById('dockerStatus').innerHTML = '<span class="badge badge-danger">Connection Error</span>';
            }
        }

        // --- Container Management ---

        async function loadContainers() {
            if (!dockerAvailable) return;

            const showAll = document.getElementById('showAllContainers').checked;
            try {
                const containers = await NetControl.api.get(`/api/docker/containers?all=${showAll}`);

                const containerList = document.getElementById('containerList');
                containerList.className = 'container-grid'; // Ensure grid class

                if (!containers || containers.length === 0) {
                    containerList.innerHTML = `
                                        <div class="empty-state" style="grid-column: 1/-1;">
                                            <h3>No Containers</h3>
                                            <p>No containers found. Start a container using Docker CLI.</p>
                                        </div>
                                    `;
                    return;
                }

                containerList.innerHTML = containers.map(c => {
                    const isRunning = c.state === 'running';
                    const statusClass = isRunning ? 'status-running' : (c.state === 'paused' ? 'status-paused' : 'status-exited');

                    return `
                                    <div class="container-card-grid">
                                        <div class="grid-header">
                                            <div>
                                                <div style="font-weight:bold; font-size:16px;">${c.name}</div>
                                                <div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">${c.image}</div>
                                            </div>
                                            <div class="status-dot ${statusClass}" title="${c.state}"></div>
                                        </div>
                                        
                                        <!-- Actions -->
                                        <div style="display:flex; gap:5px; margin-bottom:15px;">
                                            <button class="btn btn-sm btn-success" onclick="controlContainer('${c.id}', 'start')" ${isRunning ? 'disabled' : ''}>Start</button>
                                            <button class="btn btn-sm btn-warning" onclick="controlContainer('${c.id}', 'stop')" ${!isRunning ? 'disabled' : ''}>Stop</button>
                                            <button class="btn btn-sm btn-info" onclick="controlContainer('${c.id}', 'restart')">Rest</button>
                                            <button class="btn btn-sm btn-secondary" onclick="showLogs('${c.id}')">Logs</button>
                                            <button class="btn btn-sm btn-danger" onclick="removeContainer('${c.id}')">Del</button>
                                        </div>

                                        <!-- Realtime Stats -->
                                        <div id="stats-${c.id}" style="opacity: ${isRunning ? 1 : 0.5}">
                                            <div>
                                                <div class="resource-label">
                                                    <span>CPU</span>
                                                    <span id="cpu-val-${c.id}">0%</span>
                                                </div>
                                                <div class="resource-bar">
                                                    <div class="resource-fill" id="cpu-bar-${c.id}"></div>
                                                </div>
                                            </div>
                                            <div style="margin-top:10px;">
                                                <div class="resource-label">
                                                    <span>Memory</span>
                                                    <span id="mem-val-${c.id}">0 MB</span>
                                                </div>
                                                <div class="resource-bar">
                                                    <div class="resource-fill" id="mem-bar-${c.id}"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                }).join('');

                // Note: We no longer call updateAllContainerStats() here because WebSocket handles data push.

            } catch (e) {
                console.error("Load containers failed", e);
            }
        }

        async function loadImages() {
            const images = await NetControl.api.get('/api/docker/images');

            if (!images || images.length === 0) {
                document.getElementById('imageList').innerHTML = `
                    <div class="empty-state">
                        <h3>No Images</h3>
                        <p>No images found. Pull an image to get started.</p>
                    </div>
                `;
                return;
            }

            document.getElementById('imageList').innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Repository</th>
                            <th>Tag</th>
                            <th>ID</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${images.map(img => {
                const tag = img.repo_tags && img.repo_tags[0] ? img.repo_tags[0] : '<none>:<none>';
                const [repo, version] = tag.split(':');
                return `
                                <tr>
                                    <td>${repo}</td>
                                    <td><span class="badge badge-info">${version}</span></td>
                                    <td><code>${img.id}</code></td>
                                    <td>${formatBytes(img.size)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" style="margin-right:5px;" onclick="showCreateContainerModal('${tag}', '${repo}:${version}')">Run</button>
                                        <button class="btn btn-danger btn-sm" onclick="removeImage('${img.id}')">Remove</button>
                                    </td>
                                </tr>
                            `;
            }).join('')}
                    </tbody>
                </table>
            `;
        }

        function showCreateContainerModal(fullTag, displayName) {
            document.getElementById('createImageName').value = fullTag;
            document.getElementById('createContainerName').value = '';
            document.getElementById('createContainerPorts').value = '';
            showModal('createContainerModal');
        }

        async function createContainer() {
            const image = document.getElementById('createImageName').value;
            const name = document.getElementById('createContainerName').value;
            const portsStr = document.getElementById('createContainerPorts').value;
            const mem = parseInt(document.getElementById('createContainerMem').value);
            const cpu = parseFloat(document.getElementById('createContainerCPU').value);

            if (!image) {
                NetControl.showToast('Image is required', 'error');
                return;
            }

            const ports = portsStr.split(',').map(p => p.trim()).filter(p => p);

            try {
                const result = await NetControl.api.post('/api/docker/containers', {
                    name: name,
                    image: image,
                    ports: ports,
                    memory_mb: mem,
                    cpu_cores: cpu
                });

                NetControl.showToast('Container created safely', 'success');
                hideModal('createContainerModal');

                // Switch to containers tab and reload
                switchTab('containers');

                if (result.id) {
                    await startContainer(result.id);
                }

            } catch (e) {
                console.error(e);
                NetControl.showToast('Failed to create container', 'error');
            }
        }

        async function controlContainer(id, action) {
            const endpoint = action === 'start' ? 'start' : (action === 'stop' ? 'stop' : 'restart');
            try {
                await NetControl.api.post(`/api/docker/containers/${id}/${endpoint}`);
                loadContainers();
            } catch (e) {
                NetControl.showToast(`Failed to ${action} container: ${e.message}`, 'error');
            }
        }

        async function startContainer(id) { await controlContainer(id, 'start'); }
        async function stopContainer(id) { await controlContainer(id, 'stop'); }
        async function restartContainer(id) { await controlContainer(id, 'restart'); }

        async function removeContainer(id) {
            if (await NetControl.confirmAction('Are you sure you want to remove this container?')) {
                await NetControl.api.delete(`/api/docker/containers/${id}?force=true`);
                loadContainers();
            }
        }

        async function showLogs(id) {
            const data = await NetControl.api.get(`/api/docker/containers/${id}/logs?tail=200`);
            document.getElementById('logsContent').textContent = data.logs || 'No logs available';
            showModal('logsModal');
        }

        function showPullModal() {
            document.getElementById('imageName').value = '';
            document.getElementById('pullProgress').style.display = 'none';
            document.getElementById('pullLogs').textContent = '';
            showModal('pullModal');
        }

        async function pullImage() {
            const imageName = document.getElementById('imageName').value.trim();
            if (!imageName) return;

            document.getElementById('pullProgress').style.display = 'block';
            document.getElementById('pullBtn').disabled = true;

            try {
                const response = await fetch('/api/docker/images/pull', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageName })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    document.getElementById('pullLogs').textContent += text;
                }

                loadImages();
            } finally {
                document.getElementById('pullBtn').disabled = false;
            }
        }

        async function removeImage(id) {
            if (await NetControl.confirmAction('Are you sure you want to remove this image?')) {
                await NetControl.api.delete(`/api/docker/images/${id}?force=true`);
                loadImages();
            }
        }

        // --- Installer Logic ---

        function installDocker() {
            startOperation('ws/installer/docker');
        }

        async function uninstallDocker() {
            if (await NetControl.confirmAction('Are you sure you want to uninstall Docker? This will remove all containers and images.')) {
                startOperation('ws/installer/docker/uninstall');
            }
        }

        async function restartSoftware(service) {
            if (await NetControl.confirmAction(`Are you sure you want to restart ${service}?`)) {
                try {
                    await NetControl.api.post(`/api/installer/restart/${service}`);
                    alert(`${service} restarted successfully`);
                    checkStatus();
                } catch (e) {
                    alert('Failed to restart: ' + e.message);
                }
            }
        }

        function startOperation(endpoint) {
            document.getElementById('installProgress').style.display = 'block';
            document.getElementById('installLogs').textContent = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressStatus').textContent = 'Connecting...';

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/${endpoint}`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.message) {
                    document.getElementById('installLogs').textContent += data.message + '\n';
                    document.getElementById('installLogs').scrollTop = document.getElementById('installLogs').scrollHeight;

                    const match = data.message.match(/\[(\d+)%\]/);
                    if (match) {
                        document.getElementById('progressBar').style.width = match[1] + '%';
                        document.getElementById('progressStatus').textContent = data.message;
                    }
                }
                if (data.complete) {
                    if (data.success) {
                        document.getElementById('progressStatus').textContent = 'Operation complete!';
                        document.getElementById('progressBar').style.width = '100%';
                    } else if (data.error) {
                        document.getElementById('progressStatus').textContent = 'Error: ' + data.error;
                    }
                    setTimeout(checkStatus, 2000);
                }
            };
        }

        // Initialize
        checkStatus();
    </script>
</body>

</html>