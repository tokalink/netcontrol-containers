<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Explorer - NetControl Containers</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Editor Styles */
        .editor-container {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #1e1e1e;
            height: 500px;
            font-family: 'Fira Code', 'item-monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .editor-gutter {
            background: #252526;
            color: #858585;
            padding: 10px 5px;
            text-align: right;
            min-width: 40px;
            user-select: none;
            overflow: hidden;
            border-right: 1px solid var(--border-color);
        }

        .editor-content {
            flex: 1;
            background: transparent;
            color: #d4d4d4;
            border: none;
            resize: none;
            outline: none;
            padding: 10px;
            white-space: pre;
            overflow: auto;
            tab-size: 4;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .modal {
            max-width: 800px;
            /* Wider for editor */
        }
    </style>
</head>

<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>NetControl</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="/" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                    </svg><span>Dashboard</span></a>
                <a href="/docker" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg><span>Docker</span></a>
                <a href="/kubernetes" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg><span>Kubernetes</span></a>

                <a href="/files" class="nav-item active"><svg xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg><span>File Explorer</span></a>
                <a href="/terminal" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg><span>Terminal</span></a>
                <a href="/wireguard" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.131A8 8 0 008 8mc0-4.144" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" />
                    </svg>
                    <span>WireGuard</span>
                </a>
                <a href="/settings" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg><span>Settings</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="avatar">{{.Username}}</div><span>{{.Username}}</span>
                </div>
                <button class="logout-btn" onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg></button>
            </div>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1>üìÅ File Explorer</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="goUp()">‚¨ÜÔ∏è Up</button>
                    <button class="btn btn-secondary btn-sm" onclick="refresh()">üîÑ Refresh</button>
                    <button class="btn btn-primary btn-sm" onclick="showNewFolderModal()">üìÅ New Folder</button>
                    <button class="btn btn-primary btn-sm" onclick="showUploadModal()">üì§ Upload</button>
                </div>
            </header>

            <div class="content">
                <div class="section-card">
                    <div class="file-toolbar">
                        <select id="driveSelect" class="form-control" style="width: 100px;"
                            onchange="changeDrive()"></select>
                        <div class="path-breadcrumb" id="breadcrumb"></div>
                    </div>
                    <div class="file-list" id="fileList" style="height: calc(100vh - 280px);"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- New Folder -->
    <div class="modal-overlay" id="newFolderModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>New Folder</h3><button class="modal-close" onclick="hideModal('newFolderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Folder Name</label>
                    <input type="text" class="form-control" id="newFolderName" placeholder="Enter folder name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('newFolderModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>

    <!-- Upload -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Upload File</h3><button class="modal-close" onclick="hideModal('uploadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select File</label>
                    <input type="file" class="form-control" id="uploadFile">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('uploadModal')">Cancel</button>
                <button class="btn btn-primary" onclick="uploadFile()">Upload</button>
            </div>
        </div>
    </div>

    <!-- Rename -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Rename Item</h3><button class="modal-close" onclick="hideModal('renameModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="renameOldPath">
                <div class="form-group">
                    <label>New Name</label>
                    <input type="text" class="form-control" id="renameNewName" placeholder="Enter new name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('renameModal')">Cancel</button>
                <button class="btn btn-primary" onclick="doRename()">Rename</button>
            </div>
        </div>
    </div>

    <!-- Permissions -->
    <div class="modal-overlay" id="chmodModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Change Permissions</h3><button class="modal-close"
                    onclick="hideModal('chmodModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="chmodPath">
                <div class="form-group">
                    <label>Mode (Octal, e.g. 0755)</label>
                    <input type="text" class="form-control" id="chmodMode" placeholder="0755">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('chmodModal')">Cancel</button>
                <button class="btn btn-primary" onclick="doChmod()">Change</button>
            </div>
        </div>
    </div>

    <!-- Editor -->
    <div class="modal-overlay" id="editorModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit File</h3><button class="modal-close" onclick="hideModal('editorModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editorPath">
                <div class="editor-container">
                    <div class="editor-gutter" id="editorGutter">1</div>
                    <textarea class="editor-content" id="editorContent" spellcheck="false"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('editorModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveFile()">Save</button>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        let currentPath = '/';

        // Editor Logic
        const editorContent = document.getElementById('editorContent');
        const editorGutter = document.getElementById('editorGutter');

        editorContent.addEventListener('input', updateLineNumbers);
        editorContent.addEventListener('scroll', () => {
            editorGutter.scrollTop = editorContent.scrollTop;
        });

        function updateLineNumbers() {
            const lines = editorContent.value.split('\n').length;
            editorGutter.innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>');
        }

        async function loadDrives() {
            const data = await NetControl.api.get('/api/files/drives');
            const select = document.getElementById('driveSelect');
            select.innerHTML = data.drives.map(d => `<option value="${d}">${d}</option>`).join('');
            currentPath = data.drives[0] || '/';
            loadFiles();
        }

        function changeDrive() {
            currentPath = document.getElementById('driveSelect').value;
            loadFiles();
        }

        async function loadFiles() {
            const data = await NetControl.api.get(`/api/files?path=${encodeURIComponent(currentPath)}`);
            updateBreadcrumb();

            if (!data.files || data.files.length === 0) {
                document.getElementById('fileList').innerHTML = '<div class="empty-state"><h3>Empty folder</h3></div>';
                return;
            }

            document.getElementById('fileList').innerHTML = data.files.map(f => `
                <div class="file-item" ondblclick="${f.is_dir ? `navigateTo('${f.path.replace(/\\/g, '\\\\')}')` : `openEditor('${f.path.replace(/\\/g, '\\\\')}', '${f.extension}')`}">
                    <span class="file-icon">${f.is_dir ? 'üìÅ' : getFileIcon(f.extension)}</span>
                    <span class="file-name">${f.name}</span>
                    <span class="file-size">${f.is_dir ? '' : formatBytes(f.size)}</span>
                    <div class="action-buttons">
                        ${!f.is_dir ? `<button class="btn btn-sm btn-secondary" title="Edit" onclick="openEditor('${f.path.replace(/\\/g, '\\\\')}', '${f.extension}')">üìù</button>` : ''}
                        ${!f.is_dir ? `<button class="btn btn-sm btn-secondary" title="Download" onclick="downloadFile('${f.path.replace(/\\/g, '\\\\')}')">‚¨áÔ∏è</button>` : ''}
                        <button class="btn btn-sm btn-warning" title="Rename" onclick="openRename('${f.path.replace(/\\/g, '\\\\')}', '${f.name}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-info" title="Permissions" onclick="openChmod('${f.path.replace(/\\/g, '\\\\')}', '${f.mode}')">üîí</button>
                        <button class="btn btn-sm btn-danger" title="Delete" onclick="deleteFile('${f.path.replace(/\\/g, '\\\\')}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function getFileIcon(ext) {
            const icons = {
                'txt': 'üìÑ', 'md': 'üìù', 'json': 'üìã', 'xml': 'üìã',
                'js': 'üü®', 'ts': 'üî∑', 'go': 'üîµ', 'py': 'üêç',
                'html': 'üåê', 'css': 'üé®', 'php': 'üêò',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'svg': 'üñºÔ∏è',
                'mp3': 'üéµ', 'wav': 'üéµ', 'mp4': 'üé¨', 'avi': 'üé¨',
                'zip': 'üì¶', 'tar': 'üì¶', 'gz': 'üì¶', '7z': 'üì¶',
                'exe': '‚öôÔ∏è', 'sh': '‚öôÔ∏è', 'bat': '‚öôÔ∏è',
                'pdf': 'üìï', 'doc': 'üìò', 'docx': 'üìò', 'xls': 'üìó', 'xlsx': 'üìó'
            };
            return icons[ext?.toLowerCase()] || 'üìÑ';
        }

        function updateBreadcrumb() {
            // Fix regex to work on both Unix and Windows
            const isWindows = currentPath.indexOf(':') !== -1;
            const parts = currentPath.split(isWindows ? '\\' : '/').filter(p => p);

            let path = '';
            let validParts = [];

            // Handle drive letter specially for Windows
            if (isWindows && currentPath.includes(':')) {
                // Already handled by basic split usually, but let's be safe
            }

            const crumbs = parts.map((p, i) => {
                if (isWindows) {
                    if (i === 0) {
                        path = p + '\\';
                    } else {
                        path = path.endsWith('\\') ? path + p : path + '\\' + p;
                    }
                } else {
                    path = path === '/' ? '/' + p : path + '/' + p;
                }

                return `<span onclick="navigateTo('${path.replace(/\\/g, '\\\\')}')" style="cursor:pointer;color:var(--accent-blue);">${p}</span>`;
            });
            document.getElementById('breadcrumb').innerHTML = crumbs.join(' / ') || '/';
        }

        function navigateTo(path) {
            currentPath = path;
            loadFiles();
        }

        function goUp() {
            const isWindows = currentPath.indexOf(':') !== -1;
            const parts = currentPath.split(isWindows ? /\\/ : /\//).filter(p => p);

            if (parts.length > 1) {
                parts.pop();
                currentPath = parts.join(isWindows ? '\\' : '/');
                if (isWindows && !currentPath.endsWith('\\')) currentPath += '\\';
                if (!isWindows && !currentPath.startsWith('/')) currentPath = '/' + currentPath;
                loadFiles();
            } else if (parts.length === 1 && !isWindows) {
                currentPath = '/';
                loadFiles();
            }
        }

        function refresh() {
            loadFiles();
        }

        // --- Actions ---

        function showNewFolderModal() {
            document.getElementById('newFolderName').value = '';
            showModal('newFolderModal');
        }

        async function createFolder() {
            const name = document.getElementById('newFolderName').value.trim();
            if (!name) return;
            const isWindows = currentPath.indexOf(':') !== -1;
            const sep = isWindows ? '\\' : '/';
            let target = currentPath.endsWith(sep) ? currentPath + name : currentPath + sep + name;

            await NetControl.api.post('/api/files/create', { path: target, is_dir: true });
            hideModal('newFolderModal');
            loadFiles();
        }

        function showUploadModal() {
            document.getElementById('uploadFile').value = '';
            showModal('uploadModal');
        }

        async function uploadFile() {
            const fileInput = document.getElementById('uploadFile');
            if (!fileInput.files[0]) return;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('path', currentPath);

            await fetch('/api/files/upload', { method: 'POST', body: formData });
            hideModal('uploadModal');
            loadFiles();
        }

        function downloadFile(path) {
            window.open(`/api/files/download?path=${encodeURIComponent(path)}`, '_blank');
        }

        async function deleteFile(path) {
            if (await NetControl.confirmAction('Delete this item?')) {
                await NetControl.api.delete(`/api/files?path=${encodeURIComponent(path)}`);
                loadFiles();
            }
        }

        // --- Rename ---
        function openRename(path, name) {
            document.getElementById('renameOldPath').value = path;
            document.getElementById('renameNewName').value = name;
            showModal('renameModal');
        }

        async function doRename() {
            const oldPath = document.getElementById('renameOldPath').value;
            const newName = document.getElementById('renameNewName').value;
            if (!newName) return;

            const isWindows = oldPath.indexOf(':') !== -1;
            const sep = isWindows ? '\\' : '/';
            // Get directory of old path
            const dir = oldPath.substring(0, oldPath.lastIndexOf(sep));
            const newPath = dir + sep + newName;

            try {
                await NetControl.api.post('/api/files/rename', { old_path: oldPath, new_path: newPath });
                hideModal('renameModal');
                loadFiles();
            } catch (e) {
                alert('Rename failed: ' + e.message);
            }
        }

        // --- Permissions ---
        function openChmod(path, modeStr) {
            // modeStr usually comes as "-rwxr-xr-x" or similar from os.FileMode.String()
            // We need to support inputting octal. The placeholder is 0755.
            // Converting symbolic to octal is complex in JS, so we'll just let user enter new octal.
            document.getElementById('chmodPath').value = path;
            document.getElementById('chmodMode').value = ''; // Reset, or try to guess? Better empty.
            showModal('chmodModal');
        }

        async function doChmod() {
            const path = document.getElementById('chmodPath').value;
            const mode = document.getElementById('chmodMode').value;
            if (!mode) return;

            try {
                await NetControl.api.post('/api/files/chmod', { path: path, mode: mode });
                hideModal('chmodModal');
                loadFiles(); // Mode might update
            } catch (e) {
                alert('Change permissions failed: ' + e.message);
            }
        }

        // --- Editor ---
        const TEXT_EXTENSIONS = ['txt', 'md', 'json', 'xml', 'js', 'ts', 'go', 'py', 'html', 'css', 'php', 'sh', 'bat', 'yaml', 'yml', 'toml', 'ini', 'conf', 'cfg', 'log'];

        async function openEditor(path, ext) {
            // Basic check if text file
            if (!TEXT_EXTENSIONS.includes(ext.toLowerCase())) {
                if (!confirm('This file may not be a text file. Open anyway?')) return;
            }

            try {
                const data = await NetControl.api.get(`/api/files/content?path=${encodeURIComponent(path)}`);
                document.getElementById('editorPath').value = path;
                document.getElementById('editorContent').value = data.content || '';
                updateLineNumbers();
                showModal('editorModal');
            } catch (e) {
                alert('Failed to load file: ' + e.message);
            }
        }

        async function saveFile() {
            const path = document.getElementById('editorPath').value;
            const content = document.getElementById('editorContent').value;

            try {
                await NetControl.api.post('/api/files/content', { path: path, content: content });
                NetControl.showToast('File saved successfully!', 'success');
                hideModal('editorModal');
                loadFiles();
            } catch (e) {
                alert('Failed to save: ' + e.message);
            }
        }

        loadDrives();
    </script>
</body>

</html>